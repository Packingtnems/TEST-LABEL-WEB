<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K·∫æT QU·∫¢ TEST - Zebra ZT610</title>
  <style>
    /* Common styles */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fa; }
    .container { padding: 20px; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-buttons button {
      padding: 10px 20px; border: none; border-radius: 6px;
      background: #34495e; color: #fff; cursor: pointer;
    }
    .tab-buttons button.active { background: #27ae60; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m */
    .app-container { display: flex; flex-direction: row; }
    .left, .right { padding: 20px; overflow-y: auto; }
    .left { width: 40%; border-right: 2px solid #ccc; position: relative; }
    .right { width: 60%; }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select { padding: 5px; width: 200px; margin-bottom: 10px; }
    button { padding: 8px 16px; margin: 6px; border-radius: 6px; border: 1px solid #333; font-size: 14px; cursor: pointer; }
    #okBtn { color: green; }
    #ngBtn { color: red; }
    #error { color: red; font-weight: bold; margin-top: 10px; }
    table { margin-top: 10px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .duplicate { background-color: #ffb3b3; }
    #loginScreen { margin-top: 50px; text-align: center; }
    .mainApp { display: none; }
    #clearLogBtn, #resetDataBtn { position: absolute; top: 12px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #clearLogBtn { right: 120px; background: #3498db; color: white; }
    #clearLogBtn:hover { background: #2980b9; }
    #resetDataBtn { right: 12px; background: #e74c3c; color: white; }
    #resetDataBtn:hover { background: #c0392b; }
    .stat { margin-top: 8px; font-size: 14px; }
    
    /* Tab 2: L·ªçc d·ªØ li·ªáu */
    .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { font-size: 13px; color: #555; margin-bottom: 4px; }
    .filter-item input, .filter-item select {
      padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; background: #fff;
    }
    .button-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-filter {
      background: #34495e; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-filter:hover { background: #2c3e50; }
    .btn-download {
      background: #27ae60; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-download:hover { background: #1e874b; }
    
    /* Tab 3: Bi·ªÉu ƒë·ªì */
    .chart-container { margin-bottom: 30px; }
    .chart-container h3 { margin-bottom: 10px; }
    canvas { max-width: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
    
    /* Th√™m style cho th√¥ng b√°o */
    .sync-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .sync-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .sync-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Style cho in QR Code */
    .qr-print-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 2px solid #333;
      border-radius: 8px;
      z-index: 1000;
      text-align: center;
    }

    .qr-content {
      margin: 10px 0;
      font-size: 16px;
      font-weight: bold;
    }

    .qr-code {
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      border: 1px dashed #ccc;
      background: #f9f9f9;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    /* Tab 4: C·∫•u h√¨nh m√°y in */
    .printer-config-panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }

    .printer-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .printer-status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-weight: bold;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-testing {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .config-section {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    .usb-device-info {
      background: #e8f4fd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #b8daff;
    }
    
    .usb-troubleshoot {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ffeaa7;
      margin: 15px 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div style="margin-top:20px; display:flex; gap:10px; ">
    <img src="logo.png" alt="Logo" style="height: 100px; width: auto; margin-right: 20px;">
    <h2>üìä K·∫æT QU·∫¢ TEST - ZEBRA ZT610</h2>
  </div>

  <div class="tab-buttons">
    <button id="btnTab1" class="active" onclick="showTab(1)">üìù Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</button>
    <button id="btnTab2" onclick="showTab(2)">üìë D·ªØ li·ªáu</button>
    <button id="btnTab3" onclick="showTab(3)">üìà Bi·ªÉu ƒë·ªì</button>
    <button id="btnTab4" onclick="showTab(4)">üñ®Ô∏è C·∫•u h√¨nh M√°y in</button>
  </div>
  
  <!-- Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m -->
  <div id="tab1" class="tab-content active">
    <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
    <div id="loginScreen">
      <h2>ƒêƒÉng nh·∫≠p</h2>
      <label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label>
      <input type="text" id="loginUser" placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">

      <label for="loginPass">M·∫≠t kh·∫©u</label>
      <input type="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">

      <label for="shift">Ch·ªçn ca</label>
      <select id="shift">
        <option value="Ca 1 (06:00-14:00)">Ca 1 (06:00 - 14:00)</option>
        <option value="Ca 2 (14:00-22:00)">Ca 2 (14:00 - 22:00)</option>
        <option value="Ca 1 d√†i (06:00-18:00)">Ca 1 d√†i (06:00 - 18:00)</option>
        <option value="Ca 2 d√†i (18:00-06:00)">Ca 2 d√†i (18:00 - 06:00 h√¥m sau)</option>
        <option value="Ca HC (08:00-16:30)">Ca HC (08:00 - 16:30)</option>
      </select>

      <label for="wo">S·ªë l·ªánh s·∫£n xu·∫•t (WO)</label>
      <input type="text" id="wo" placeholder="Nh·∫≠p s·ªë WO" oninput="this.value=this.value.toUpperCase()">

      <br>
      <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <p id="loginError" style="color:red;"></p>
    </div>

    <!-- Giao di·ªán ch√≠nh -->
    <div id="mainApp" class="mainApp app-container">
      <!-- C·ªôt tr√°i -->
      <div class="left">
        <h2>Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</h2>
        <button id="clearLogBtn" onclick="clearLogDisplay()">X√≥a log</button>
        <button id="resetDataBtn" onclick="resetAllData()">Reset d·ªØ li·ªáu</button>

        <p class="stat">üë§ Ng∆∞·ªùi ki·ªÉm tra: <b id="currentUser"></b></p>
        <p class="stat">üïí Ca: <b id="currentShift"></b></p>
        <p class="stat">üìã WO: <b id="currentWO"></b></p>
        <p class="stat">‚úÖ OK: <b id="okCount">0</b> | ‚ùå NG: <b id="ngCount">0</b></p>

        <label for="deliveryQty"><b>S·ªê L∆Ø·ª¢NG GIAO</b></label>
        <input type="number" id="deliveryQty" value="0" min="0" style="width:150px;">
        <p id="deliveryStatus" style="color:blue;font-weight:bold;"></p>

        <label for="mahang">M√£ h√†ng</label>
        <select id="mahang" onchange="updateQRCodeMaxLength()">
          <option value="">-- Ch·ªçn m√£ h√†ng --</option>
          <option value="ECM-2583-236">ECM-2583-236</option>
          <option value="ECM-2583-164">ECM-2583-164</option>
          <option value="ECM-2300">ECM-2300</option>
          <option value="ECM-2310">ECM-2310</option>
          <option value="IZ-1-R3">IZ-1-R3</option>
          <option value="RM-4K-R3">RM-4K-R3</option>
          <option value="AM-4-R3">AM-4-R3</option>
          <option value="P-7937">P-7937</option>
          <option value="P-8105">P-8105</option>
          <option value="P-8149">P-8149</option>
          <option value="BMS 85AH">BMS 85AH</option>
          <option value="BMS 57AH">BMS 57AH</option>
          <option value="CONTROLLER">CONTROLLER</option>
          <option value="CAS NEMO">CAS NEMO</option>
          <option value="CAS MINI-DI">CAS MINI-DI</option>
          <option value="CAS MINI-485">CAS MINI-485</option>
          <option value="BN 2573A">BN 2573A</option>
          <option value="OEM">OEM</option>
        </select>
        <p id="qrcodeLengthInfo" style="font-size: 12px; color: #666; margin-top: -5px; margin-bottom: 10px;"></p>
        <label for="qrcode">QR Code</label>
        <input type="text" id="qrcode" placeholder="Qu√©t QR code" oninput="this.value=this.value.toUpperCase()">

        <label for="loi">L·ªói / Ghi ch√∫</label>
        <div style="display: flex; gap: 10px;">
          <input list="errorList" id="loi" placeholder="Nh·∫≠p l·ªói (n·∫øu c√≥)">
          <input type="text" id="ghichu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
        </div>
        <datalist id="errorList">
          <option value="√ÅP CAO">√ÅP CAO</option>
          <option value="√ÅP TH·∫§P">√ÅP TH·∫§P</option>
          <option value="HALL SENSOR">HALL SENSOR</option>
          <option value="R CAO">R CAO</option>
          <option value="LAMDA FAIL">LAMDA FAIL</option>
          <option value="KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE">KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE</option>
          <option value="KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH">KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH</option>
          <option value="VƒÇN TAY GA KH√îNG L√äN">VƒÇN TAY GA KH√îNG L√äN</option>
          <option value="N·ªî T·ª§ NH·ªé">N·ªî T·ª§ NH·ªé</option>
          <option value="D√íNG CAO">D√íNG CAO</option>
          <option value="V DISCHARGE TH·∫§P">V DISCHARGE TH·∫§P</option>
          <option value="V CHARGE TH√ÇP">V CHARGE TH√ÇP</option>
          <option value="V > 30V">V > 30V</option>
          <option value="L·ªói 3M">L·ªói 3M</option>
          <option value="C13,C14">C13,C14</option>
          <option value="C5,C6">C5,C6</option>
          <option value="C12,C13">C12,C13</option>
          <option value="C23">C23</option>
          <option value="NTC1">NTC1</option>
          <option value="NTC2">NTC2</option>
          <option value="TOP AFE">TOP AFE</option>
        </datalist>

        <div>
          <button id="okBtn" onclick="saveData('OK')">OK</button>
          <button id="ngBtn" onclick="saveData('NG')">NG</button>
          <button id="printQRBtn" onclick="printQRCode()" style="background:#9b59b6;color:white;">üìÑ In QR Code</button>
        </div>
      
        <p id="error"></p>

        <!-- Th√™m th√¥ng b√°o tr·∫°ng th√°i ƒë·ªìng b·ªô -->
        <div id="syncStatus" class="sync-status"></div>

        <div>
          <button onclick="exportCSV()">Xu·∫•t logfile</button>
          <button onclick="syncToSheet()">ƒê·ªìng b·ªô Google Sheets</button>
          <button onclick="endShiftReport()">B√°o c√°o cu·ªëi ca</button>
        </div>

        <!-- Bi·ªÉu ƒë·ªì realtime -->
        <div>
          <h3>B√°o c√°o real-time</h3>
          <div style="width: 200px; height: 200px;">
            <canvas id="chartOKNG"></canvas>
          </div>
        </div>
      </div>

      <!-- C·ªôt ph·∫£i -->
      <div class="right">
        <!-- B·ªô l·ªçc -->
        <div>
          <input type="text" id="searchBox" placeholder="T√¨m QR / M√£ h√†ng" onkeyup="renderTable()">
          <select id="filterResult" onchange="renderTable()">
            <option value="">--T·∫•t c·∫£--</option>
            <option value="OK">OK</option>
            <option value="NG">NG</option>
          </select>
        </div>
        <table id="logTable">
          <thead>
            <tr>
              <th>M√£ h√†ng</th>
              <th>QR Code</th>
              <th>Ph√¢n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Ng√†y</th>
              <th>Gi·ªù</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ nh√¢n vi√™n</th>
              <th>Shift</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Tab 2: D·ªØ li·ªáu -->
  <div id="tab2" class="tab-content">
    <div class="filter-container">
      <div class="filter-item">
        <label for="fromDate">T·ª´ ng√†y</label>
        <input type="date" id="fromDate">
      </div>
      <div class="filter-item">
        <label for="toDate">ƒê·∫øn ng√†y</label>
        <input type="date" id="toDate">
      </div>
      <div class="filter-item">
        <label for="maSP">M√£ s·∫£n ph·∫©m</label>
        <select id="maSP"><option value="">T·∫•t c·∫£ m√£</option></select>
      </div>
      <div class="filter-item">
        <label for="searchQR">T√¨m QR Code</label>
        <input type="text" id="searchQR" placeholder="Nh·∫≠p QR Code ƒë·ªÉ l·ªçc..." oninput="applyFilters()">
      </div>
      <div class="filter-item">
        <label for="po">PO</label>
        <select id="po"><option value="">T·∫•t c·∫£ PO</option></select>
      </div>
    </div>

    <div class="button-container">
      <button class="btn-filter" onclick="applyFilters()">L·ªçc d·ªØ li·ªáu</button>
      <button class="btn-download" onclick="reloadFromGoogle()">‚≠Æ T·∫£i t·ª´ Google Sheets</button>
    </div>

    <div id="scrollArea" style="height:500px; overflow:auto; border:1px solid #ccc;">
      <table id="reportTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th>M√£ H√†ng</th>
            <th>QR Code</th>
            <th>Ph√°n ƒë·ªãnh</th>
            <th>M√¥ t·∫£ l·ªói</th>
            <th>Gi·ªù</th>
            <th>Ng√†y</th>
            <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
            <th>M√£ nh√¢n vi√™n</th>
            <th>Ca</th>
            <th>PO</th>
            <th>Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody id="clusterize-content" class="clusterize-content"></tbody>
      </table>

      <!-- ‚úÖ B·∫Øt bu·ªôc ph·∫£i n·∫±m TRONG scrollArea, ngay d∆∞·ªõi b·∫£ng -->
      <div id="clusterize-scroll" class="clusterize-scroll"></div>
    </div>

    <!-- D√≤ng n√†y n·∫±m ngo√†i ƒë·ªÉ hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng -->
    <div id="recordCount" style="margin-top:5px; font-weight:bold;"></div>
  </div>
    
  <!-- Tab 3: Bi·ªÉu ƒë·ªì -->
  <div id="tab3" class="tab-content">
    <div class="chart-container">
      <h3>üìä Bi·ªÉu ƒë·ªì Pareto (theo M√¥ t·∫£ l·ªói)</h3>
      <div style="height: 400px;">
        <canvas id="paretoChart"></canvas>
      </div>
    </div>
    
    <div class="chart-container">
      <h3>üìà Bi·ªÉu ƒë·ªì so s√°nh theo ng√†y</h3>
      <div style="height: 400px;">
        <canvas id="dailyChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Tab 4: C·∫•u h√¨nh M√°y in -->
  <div id="tab4" class="tab-content">
    <div class="printer-config-panel">
      <h3>üñ®Ô∏è C·∫§U H√åNH M√ÅY IN ZEBRA ZT610</h3>
      
      <div class="config-section">
        <h4>üì° Lo·∫°i k·∫øt n·ªëi</h4>
        <div class="printer-option">
          <input type="radio" id="printerTypeNetwork" name="printerType" value="network">
          <label for="printerTypeNetwork">M√°y in m·∫°ng (Network)</label>
        </div>
        
        <div class="printer-option">
          <input type="radio" id="printerTypeUSB" name="printerType" value="usb" checked>
          <label for="printerTypeUSB">M√°y in USB</label>
        </div>
        
        <div class="printer-option">
          <input type="radio" id="printerTypeLocal" name="printerType" value="local">
          <label for="printerTypeLocal">M√°y in c·ª•c b·ªô (Local)</label>
        </div>
      </div>

      <div class="config-section" id="networkConfig" style="display: none;">
        <h4>üåê C·∫•u h√¨nh m·∫°ng</h4>
        <label for="printerIP">ƒê·ªãa ch·ªâ IP:</label>
        <input type="text" id="printerIP" placeholder="192.168.1.100" style="width: 200px;">
        
        <label for="printerPort" style="margin-top: 10px;">Port:</label>
        <input type="number" id="printerPort" value="9100" style="width: 100px;">
        
        <button onclick="testNetworkPrinter()" style="background:#17a2b8;color:white;margin-left:10px;">üîß Ki·ªÉm tra k·∫øt n·ªëi</button>
      </div>

      <div class="config-section" id="usbConfig">
        <h4>üîå C·∫§U H√åNH USB - ZEBRA ZT610</h4>
        
        <div id="usbDeviceInfo" class="usb-device-info" style="display: none;">
          <strong>üìã Thi·∫øt b·ªã ƒë√£ ch·ªçn:</strong>
          <div id="usbDeviceDetails" style="font-size: 12px; margin-top: 5px;"></div>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <button onclick="quickUSBCheck()" style="background:#9b59b6;color:white;">üîé Ki·ªÉm tra nhanh USB</button>
          <button onclick="requestUSBDevice()" style="background:#17a2b8;color:white;">üîå Ch·ªçn thi·∫øt b·ªã USB</button>
          <button onclick="testUSBPrinter()" style="background:#27ae60;color:white;">üß™ Ki·ªÉm tra m√°y in</button>
          <button onclick="showUSBPermissionStatus()" style="background:#f39c12;color:white;">üîç Ki·ªÉm tra quy·ªÅn</button>
        </div>
        
        <div class="usb-troubleshoot">
          <strong>üö® KH·∫ÆC PH·ª§C S·ª∞ C·ªê ZEBRA ZT610:</strong><br>
          1. <strong>K·∫øt n·ªëi USB</strong>: C·∫Øm tr·ª±c ti·∫øp v√†o m√°y t√≠nh (kh√¥ng qua hub)<br>
          2. <strong>B·∫≠t ngu·ªìn</strong>: ƒê·∫£m b·∫£o ZT610 ƒëang b·∫≠t v√† s·∫µn s√†ng<br>
          3. <strong>Tr√¨nh duy·ªát</strong>: D√πng Chrome/Edge phi√™n b·∫£n m·ªõi<br>
          4. <strong>Quy·ªÅn USB</strong>: Click üîí icon ‚Üí "Site settings" ‚Üí "USB devices" ‚Üí "Allow"<br>
          5. <strong>Driver</strong>: C√†i ƒë·∫∑t driver Zebra Link-OS n·∫øu c·∫ßn
        </div>
      </div>

      <div class="config-section" id="localConfig" style="display: none;">
        <h4>üíª M√°y in c·ª•c b·ªô</h4>
        <label for="localPrinterName">T√™n m√°y in:</label>
        <input type="text" id="localPrinterName" placeholder="ZDesigner GT800" style="width: 250px;">
        <button onclick="testLocalPrinter()" style="background:#17a2b8;color:white;margin-left:10px;">üîß Ki·ªÉm tra m√°y in</button>
      </div>

      <div class="config-section">
        <h4>‚öôÔ∏è C·∫§U H√åNH NH√ÉN 25x10mm</h4>
        <label for="labelWidth">Chi·ªÅu r·ªông (mm):</label>
        <input type="number" id="labelWidth" value="25" min="10" max="100" style="width: 80px;">
        
        <label for="labelHeight" style="margin-left: 15px;">Chi·ªÅu cao (mm):</label>
        <input type="number" id="labelHeight" value="10" min="5" max="50" style="width: 80px;">
        
        <label for="printDensity" style="margin-left: 15px;">M·∫≠t ƒë·ªô in:</label>
        <select id="printDensity">
          <option value="6">6 - Nh·∫π</option>
          <option value="8" selected>8 - B√¨nh th∆∞·ªùng</option>
          <option value="10">10 - ƒê·∫≠m</option>
          <option value="12">12 - R·∫•t ƒë·∫≠m</option>
        </select>
        
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
          <strong>K√≠ch th∆∞·ªõc nh√£n:</strong> 25mm x 10mm (200 dots x 80 dots)
        </div>
      </div>

      <div id="printerStatus" class="printer-status status-disconnected">
        üî¥ Ch∆∞a k·∫øt n·ªëi m√°y in
      </div>

      <div style="margin-top: 20px;">
        <button onclick="savePrinterConfig()" style="background:#27ae60;color:white;">üíæ L∆∞u c·∫•u h√¨nh</button>
        <button onclick="loadPrinterConfig()" style="background:#3498db;color:white;">üì• T·∫£i c·∫•u h√¨nh</button>
        <button onclick="printTestLabel()" style="background:#9b59b6;color:white;">üß™ In nh√£n th·ª≠ nghi·ªám</button>
      </div>
    </div>
  </div>

  <!-- Popup in QR Code -->
  <div id="printOverlay" class="overlay" onclick="closeQRPrint()"></div>
  <div id="qrPrintContainer" class="qr-print-container">
    <div style="font-weight:bold; margin-bottom:15px; font-size:18px;">üìÑ IN QR CODE</div>
    
    <div class="qr-code" id="qrCodeDisplay"></div>
    
    <div style="margin-top: 20px;">
      <button onclick="printQRNowReal()" style="background:#27ae60;color:white;padding:8px 16px;border:none;border-radius:4px;margin-right:10px;cursor:pointer;">üñ®Ô∏è In Th·∫≠t</button>
      <button onclick="printQRNow()" style="background:#3498db;color:white;padding:8px 16px;border:none;border-radius:4px;margin-right:10px;cursor:pointer;">üëÅÔ∏è M√¥ ph·ªèng</button>
      <button onclick="closeQRPrint()" style="background:#e74c3c;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    // ===== H√ÄM QU·∫¢N L√ù TAB =====
    function showTab(n) {
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('btnTab' + n).classList.add('active');
      document.getElementById('tab' + n).classList.add('active');
      
      if (n === 3) {
        setTimeout(() => {
          const dataToUse = filteredDataGlobal.length > 0 ? filteredDataGlobal : allData;
          drawPareto(dataToUse);
          drawDailyChart(dataToUse);
        }, 100);
      }
      
      if (n === 2 && !window.preventAutoReload) {
        reloadFromGoogle();
      }

      if (n === 4) {
        loadPrinterConfig();
        updatePrinterTypeUI();
      }
    }

    // ===== C·∫§U H√åNH M√ÅY IN TH·∫¨T =====
    let printerConfig = {
      type: 'usb',
      ip: '192.168.1.100',
      port: 9100,
      localName: 'ZDesigner ZT610',
      labelWidth: 25,  // 25mm cho ZT610
      labelHeight: 10, // 10mm cho ZT610
      density: 8
    };

    let usbDevice = null;

    // C·∫≠p nh·∫≠t UI theo lo·∫°i m√°y in
    function updatePrinterTypeUI() {
      const type = document.querySelector('input[name="printerType"]:checked').value;
      
      document.getElementById('networkConfig').style.display = type === 'network' ? 'block' : 'none';
      document.getElementById('usbConfig').style.display = type === 'usb' ? 'block' : 'none';
      document.getElementById('localConfig').style.display = type === 'local' ? 'block' : 'none';
    }

    // L∆∞u c·∫•u h√¨nh m√°y in
    function savePrinterConfig() {
      printerConfig.type = document.querySelector('input[name="printerType"]:checked').value;
      printerConfig.ip = document.getElementById('printerIP').value;
      printerConfig.port = parseInt(document.getElementById('printerPort').value);
      printerConfig.localName = document.getElementById('localPrinterName').value;
      printerConfig.labelWidth = parseInt(document.getElementById('labelWidth').value);
      printerConfig.labelHeight = parseInt(document.getElementById('labelHeight').value);
      printerConfig.density = parseInt(document.getElementById('printDensity').value);
      
      localStorage.setItem('printerConfig', JSON.stringify(printerConfig));
      updatePrinterStatus('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh m√°y in', 'connected');
    }

    // T·∫£i c·∫•u h√¨nh m√°y in
    function loadPrinterConfig() {
      const saved = localStorage.getItem('printerConfig');
      if (saved) {
        printerConfig = JSON.parse(saved);
        
        // C·∫≠p nh·∫≠t UI
        document.querySelector(`input[value="${printerConfig.type}"]`).checked = true;
        document.getElementById('printerIP').value = printerConfig.ip || '';
        document.getElementById('printerPort').value = printerConfig.port || 9100;
        document.getElementById('localPrinterName').value = printerConfig.localName || '';
        document.getElementById('labelWidth').value = printerConfig.labelWidth || 25;
        document.getElementById('labelHeight').value = printerConfig.labelHeight || 10;
        document.getElementById('printDensity').value = printerConfig.density || 8;
        
        updatePrinterTypeUI();
        updateUSBDeviceInfo();
        updatePrinterStatus('‚úÖ ƒê√£ t·∫£i c·∫•u h√¨nh', 'connected');
      }
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i m√°y in
    function updatePrinterStatus(message, type = 'disconnected') {
      const statusEl = document.getElementById('printerStatus');
      statusEl.textContent = message;
      statusEl.className = 'printer-status status-' + type;
    }

    // C·∫≠p nh·∫≠t th√¥ng tin thi·∫øt b·ªã USB
    function updateUSBDeviceInfo() {
      const usbInfo = document.getElementById('usbDeviceInfo');
      const usbDetails = document.getElementById('usbDeviceDetails');
      
      if (usbDevice) {
        usbInfo.style.display = 'block';
        usbDetails.innerHTML = `
          <div>üì¶ ${usbDevice.productName || 'M√°y in Zebra ZT610'}</div>
          <div>üîå Vendor: 0x${usbDevice.vendorId.toString(16).toUpperCase()}</div>
          <div>üÜî Product: 0x${usbDevice.productId.toString(16).toUpperCase()}</div>
          <div>üì∂ Tr·∫°ng th√°i: ${usbDevice.opened ? '‚úÖ ƒê√£ k·∫øt n·ªëi' : 'üî¥ Ch∆∞a k·∫øt n·ªëi'}</div>
        `;
      } else {
        usbInfo.style.display = 'none';
      }
    }

    // Ki·ªÉm tra thi·∫øt b·ªã USB c√≥ s·∫µn
    async function checkUSBDevices() {
      if (!navigator.usb) {
        return { supported: false, devices: [] };
      }

      try {
        const devices = await navigator.usb.getDevices();
        const zebraDevices = devices.filter(device => {
          const vid = device.vendorId.toString(16).toUpperCase();
          // Zebra Vendor IDs - ƒê√É TH√äM ZT610
          return ['0A5F', '05C6', '15BA', '0C2E'].includes(vid);
        });
        
        return { 
          supported: true, 
          devices: zebraDevices,
          zebraCount: zebraDevices.length
        };
      } catch (error) {
        return { supported: true, devices: [], error: error.message };
      }
    }

    // Ki·ªÉm tra nhanh USB
    async function quickUSBCheck() {
      const status = await checkUSBDevices();
      let message = 'üîç KI·ªÇM TRA NHANH USB:\n\n';
      
      if (!status.supported) {
        message += '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebUSB\nüëâ H√£y d√πng Chrome/Edge phi√™n b·∫£n m·ªõi';
      } else if (status.zebraCount > 0) {
        message += `‚úÖ T√¨m th·∫•y ${status.zebraCount} m√°y in Zebra\n`;
        message += `üì¶ C√≥ th·ªÉ k·∫øt n·ªëi ngay!`;
        
        // T·ª± ƒë·ªông ch·ªçn thi·∫øt b·ªã ƒë·∫ßu ti√™n
        usbDevice = status.devices[0];
        try {
          await connectToUSBDevice();
          message += '\n\nüîó ƒê√£ t·ª± ƒë·ªông k·∫øt n·ªëi th√†nh c√¥ng!';
        } catch (error) {
          message += `\n\n‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`;
        }
      } else {
        message += '‚ùå Kh√¥ng t√¨m th·∫•y m√°y in Zebra\n';
        message += 'üëâ H√£y k·∫øt n·ªëi m√°y in v√† nh·∫•n "Ch·ªçn thi·∫øt b·ªã USB"';
      }
      
      alert(message);
    }

    // Y√™u c·∫ßu thi·∫øt b·ªã USB - ƒê√É S·ª¨A CHO ZT610
    async function requestUSBDevice() {
      if (!navigator.usb) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebUSB API. H√£y d√πng Chrome ho·∫∑c Edge phi√™n b·∫£n m·ªõi nh·∫•t.');
        return;
      }

      try {
        const userConfirmed = confirm(`üîß C·∫§U H√åNH QUY·ªÄN USB - ZEBRA ZT610

ƒê·ªÉ k·∫øt n·ªëi m√°y in ZT610, b·∫°n c·∫ßn:

1. D√πng Chrome/Edge phi√™n b·∫£n m·ªõi
2. Cho ph√©p trang web truy c·∫≠p USB
3. Ch·ªçn ƒë√∫ng m√°y in Zebra ZT610 trong danh s√°ch

üëâ Click v√†o üîí icon trong thanh ƒë·ªãa ch·ªâ
üëâ Ch·ªçn "Site settings" 
üëâ T√¨m "USB devices" v√† ch·ªçn "Allow"

B·∫•m OK ƒë·ªÉ ti·∫øp t·ª•c ch·ªçn m√°y in.`);

        if (!userConfirmed) return;

        updatePrinterStatus('üîÑ ƒêang y√™u c·∫ßu quy·ªÅn truy c·∫≠p USB...', 'testing');

        // VENDOR ID CHO ZEBRA ZT610
        usbDevice = await navigator.usb.requestDevice({ 
          filters: [
            { vendorId: 0x0A5F }, // Zebra ZT610 (ch√≠nh)
            { vendorId: 0x05C6 }, // Zebra Technologies
            { vendorId: 0x15BA }, // Seagull Scientific
            { vendorId: 0x0C2E }, // Zebra alternate
          ]
        });

        if (!usbDevice) {
          throw new Error('Kh√¥ng ch·ªçn ƒë∆∞·ª£c thi·∫øt b·ªã USB');
        }

        await connectToUSBDevice();
        
      } catch (error) {
        console.error('L·ªói USB:', error);
        updatePrinterStatus('üî¥ L·ªói k·∫øt n·ªëi USB: ' + error.message, 'disconnected');
        
        if (error.message.includes('No device selected')) {
          alert(`‚ùå Kh√¥ng ch·ªçn ƒë∆∞·ª£c m√°y in Zebra ZT610\n\nH√£y:\n1. ƒê·∫£m b·∫£o m√°y in ƒë∆∞·ª£c k·∫øt n·ªëi USB v√† b·∫≠t ngu·ªìn\n2. D√πng Chrome/Edge\n3. Cho ph√©p quy·ªÅn USB khi tr√¨nh duy·ªát h·ªèi`);
        } else {
          alert('‚ùå L·ªói USB: ' + error.message);
        }
      }
    }

    // Ki·ªÉm tra quy·ªÅn USB
    async function checkUSBPermission() {
      if (!navigator.usb) {
        return { supported: false, message: 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebUSB' };
      }

      try {
        const devices = await navigator.usb.getDevices();
        return { 
          supported: true, 
          hasPermission: devices.length > 0,
          devices: devices
        };
      } catch (error) {
        return { 
          supported: true, 
          hasPermission: false, 
          error: error.message 
        };
      }
    }

    // Hi·ªÉn th·ªã tr·∫°ng th√°i quy·ªÅn USB
    async function showUSBPermissionStatus() {
      const status = await checkUSBPermission();
      
      let message = 'üîç TR·∫†NG TH√ÅI QUY·ªÄN USB:\n\n';
      
      if (!status.supported) {
        message += '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebUSB\nüëâ H√£y d√πng Chrome/Edge phi√™n b·∫£n m·ªõi';
      } else if (status.hasPermission) {
        message += '‚úÖ ƒê√£ c√≥ quy·ªÅn truy c·∫≠p USB\n';
        message += `üì¶ S·ªë thi·∫øt b·ªã: ${status.devices.length}`;
        
        if (status.devices.length > 0) {
          message += '\n\nüìã Thi·∫øt b·ªã ƒë√£ k·∫øt n·ªëi:';
          status.devices.forEach((device, index) => {
            message += `\n${index + 1}. ${device.productName || 'Unknown'} (VID: 0x${device.vendorId.toString(16).toUpperCase()})`;
          });
        }
      } else {
        message += '‚ö†Ô∏è Ch∆∞a c√≥ quy·ªÅn truy c·∫≠p USB\n';
        message += 'üëâ Nh·∫•n "Ch·ªçn thi·∫øt b·ªã USB" ƒë·ªÉ c·∫•p quy·ªÅn';
      }
      
      alert(message);
    }

    // K·∫øt n·ªëi t·ªõi thi·∫øt b·ªã USB - ƒê√É S·ª¨A
    async function connectToUSBDevice() {
      if (!usbDevice) {
        throw new Error('Ch∆∞a ch·ªçn thi·∫øt b·ªã USB');
      }
      
      try {
        updatePrinterStatus('üîÑ ƒêang k·∫øt n·ªëi USB...', 'testing');
        
        await usbDevice.open();
        
        // TH·ª¨ C√ÅC CONFIGURATION KH√ÅC NHAU CHO ZT610
        const configurations = usbDevice.configurations;
        let connected = false;
        
        for (let i = 0; i < configurations.length; i++) {
          try {
            await usbDevice.selectConfiguration(configurations[i].configurationValue);
            await usbDevice.claimInterface(0); // Interface 0 th∆∞·ªùng cho m√°y in
            connected = true;
            break;
          } catch (e) {
            console.log(`Th·ª≠ configuration ${i} th·∫•t b·∫°i:`, e);
            continue;
          }
        }
        
        if (!connected) {
          throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi b·∫•t k·ª≥ configuration n√†o');
        }
        
        updatePrinterStatus('‚úÖ ƒê√£ k·∫øt n·ªëi USB th√†nh c√¥ng', 'connected');
        updateUSBDeviceInfo();
        return true;
        
      } catch (error) {
        console.error('L·ªói k·∫øt n·ªëi USB:', error);
        updatePrinterStatus('‚ùå L·ªói k·∫øt n·ªëi USB: ' + error.message, 'disconnected');
        throw error;
      }
    }

    // G·ª≠i l·ªánh t·ªõi m√°y in USB - ƒê√É S·ª¨A
    async function sendToUSBPrinter(zplCode) {
      if (!usbDevice) {
        throw new Error('Ch∆∞a ch·ªçn thi·∫øt b·ªã USB. H√£y nh·∫•n "Ch·ªçn thi·∫øt b·ªã USB" tr∆∞·ªõc.');
      }
      
      try {
        // ƒê·∫£m b·∫£o ƒë√£ k·∫øt n·ªëi
        if (!usbDevice.opened) {
          await connectToUSBDevice();
        }
        
        const encoder = new TextEncoder();
        const data = encoder.encode(zplCode);
        
        // TH·ª¨ C√ÅC ENDPOINT KH√ÅC NHAU CHO ZT610
        let success = false;
        const endpoints = [1, 2, 3]; // Th·ª≠ c√°c endpoint ph·ªï bi·∫øn
        
        for (const endpoint of endpoints) {
          try {
            const result = await usbDevice.transferOut(endpoint, data);
            console.log(`ƒê√£ g·ª≠i ZPL qua USB endpoint ${endpoint}:`, result);
            success = true;
            break;
          } catch (endpointError) {
            console.log(`Endpoint ${endpoint} th·∫•t b·∫°i:`, endpointError);
            continue;
          }
        }
        
        if (!success) {
          throw new Error('Kh√¥ng t√¨m th·∫•y endpoint ph√π h·ª£p cho m√°y in ZT610');
        }
        
        return true;
        
      } catch (error) {
        console.error('L·ªói g·ª≠i USB:', error);
        throw new Error('L·ªói g·ª≠i l·ªánh USB: ' + error.message);
      }
    }

    // Ki·ªÉm tra m√°y in USB
    async function testUSBPrinter() {
      if (!usbDevice) {
        alert('Vui l√≤ng ch·ªçn thi·∫øt b·ªã USB tr∆∞·ªõc khi ki·ªÉm tra.');
        return;
      }
      
      try {
        updatePrinterStatus('üîÑ ƒêang ki·ªÉm tra m√°y in USB...', 'testing');
        
        const testZPL = generateTestZPL();
        await sendToUSBPrinter(testZPL);
        
        updatePrinterStatus('‚úÖ M√°y in ZT610 ho·∫°t ƒë·ªông t·ªët', 'connected');
        alert('‚úÖ Ki·ªÉm tra m√°y in ZT610 th√†nh c√¥ng! Nh√£n th·ª≠ nghi·ªám ƒë√£ ƒë∆∞·ª£c in.');
        
      } catch (error) {
        updatePrinterStatus('‚ùå L·ªói m√°y in USB: ' + error.message, 'disconnected');
        alert('‚ùå L·ªói ki·ªÉm tra ZT610: ' + error.message);
      }
    }

    // G·ª≠i l·ªánh t·ªõi m√°y in m·∫°ng
    async function sendToNetworkPrinter(zplCode) {
      return new Promise((resolve, reject) => {
        try {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', `http://${printerConfig.ip}:${printerConfig.port}`, true);
          xhr.timeout = 5000;
          
          xhr.onload = function() {
            if (xhr.status === 200) {
              resolve(true);
            } else {
              reject(new Error(`HTTP ${xhr.status}`));
            }
          };
          
          xhr.onerror = function() {
            reject(new Error('Network error'));
          };
          
          xhr.ontimeout = function() {
            reject(new Error('Timeout'));
          };
          
          xhr.send(zplCode);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    // Ki·ªÉm tra m√°y in m·∫°ng
    async function testNetworkPrinter() {
      updatePrinterStatus('üîÑ ƒêang ki·ªÉm tra k·∫øt n·ªëi...', 'testing');
      
      try {
        const testZPL = generateTestZPL();
        await sendToNetworkPrinter(testZPL);
        
        updatePrinterStatus('‚úÖ K·∫øt n·ªëi m√°y in m·∫°ng th√†nh c√¥ng', 'connected');
      } catch (error) {
        updatePrinterStatus('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y in', 'disconnected');
      }
    }

    // G·ª≠i t·ªõi m√°y in c·ª•c b·ªô
    async function sendToLocalPrinter(zplCode) {
      // T·∫°o blob t·ª´ ZPL
      const blob = new Blob([zplCode], { type: 'application/zpl' });
      const url = URL.createObjectURL(blob);
      
      // M·ªü c·ª≠a s·ªï in
      const printWindow = window.open(url, '_blank');
      
      if (printWindow) {
        printWindow.onload = function() {
          printWindow.print();
          setTimeout(() => {
            printWindow.close();
            URL.revokeObjectURL(url);
          }, 1000);
        };
      }
      
      return true;
    }

    // Ki·ªÉm tra m√°y in c·ª•c b·ªô
    function testLocalPrinter() {
      updatePrinterStatus('‚úÖ M√°y in c·ª•c b·ªô s·∫µn s√†ng (s·ª≠ d·ª•ng Print API)', 'connected');
    }

    // G·ª≠i l·ªánh t·ªõi m√°y in (t·ª± ƒë·ªông ch·ªçn lo·∫°i)
    async function sendToPrinter(zplCode) {
      switch (printerConfig.type) {
        case 'network':
          return await sendToNetworkPrinter(zplCode);
        case 'usb':
          return await sendToUSBPrinter(zplCode);
        case 'local':
          return await sendToLocalPrinter(zplCode);
        default:
          throw new Error('Lo·∫°i m√°y in kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
      }
    }

    // Ki·ªÉm tra k·∫øt n·ªëi m√°y in
    async function checkPrinterConnection() {
      const testZPL = generateTestZPL();
      
      try {
        await sendToPrinter(testZPL);
        return true;
      } catch (error) {
        console.error('L·ªói k·∫øt n·ªëi m√°y in:', error);
        return false;
      }
    }

    // T·∫°o ZPL cho QR code th·∫≠t - ƒê√É S·ª¨A CHO NH√ÉN 25x10mm
    function generateZPLForRealPrinter(qrData) {
      const { code, mahang, wo } = qrData;
      
      // ƒêI·ªÄU CH·ªàNH CHO NH√ÉN 25x10mm (200 dots x 80 dots)
      return `^XA
^PW200    ; Chi·ªÅu r·ªông 25mm = 200 dots (8 dots/mm)
^LL80     ; Chi·ªÅu cao 10mm = 80 dots
^FO5,5^A0N,15,15^FD${mahang || 'NO PRODUCT'}^FS
^FO5,25^BQN,2,4^FDQA,${code}^FS
^FO5,55^A0N,10,10^FD${new Date().toLocaleDateString('vi-VN')}^FS
^XZ`.trim();
    }

    // T·∫°o ZPL th·ª≠ nghi·ªám cho ZT610
    function generateTestZPL() {
      return `^XA
^PW200
^LL80
^FO5,5^A0N,15,15^FDTEST ZT610^FS
^FO5,25^BQN,2,4^FDQA,TEST123456^FS
^FO5,55^A0N,10,10^FD${new Date().toLocaleString('vi-VN')}^FS
^XZ`.trim();
    }

    // In nh√£n th·ª≠ nghi·ªám
    async function printTestLabel() {
      const testZPL = generateTestZPL();
      
      try {
        await sendToPrinter(testZPL);
        updatePrinterStatus('‚úÖ In th·ª≠ nghi·ªám th√†nh c√¥ng', 'connected');
      } catch (error) {
        updatePrinterStatus('‚ùå L·ªói in th·ª≠: ' + error.message, 'disconnected');
        showZPLFallback(testZPL);
      }
    }

    // In QR code th·∫≠t
    async function printQRNowReal() {
      if (!lastQRCode) {
        alert("Kh√¥ng c√≥ QR code ƒë·ªÉ in!");
        return;
      }

      // Ki·ªÉm tra k·∫øt n·ªëi tr∆∞·ªõc
      updatePrinterStatus('üîÑ ƒêang ki·ªÉm tra k·∫øt n·ªëi m√°y in...', 'testing');
      
      const isConnected = await checkPrinterConnection();
      
      if (!isConnected) {
        updatePrinterStatus('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y in', 'disconnected');
        showZPLFallback(generateZPLForRealPrinter(lastQRCode));
        return;
      }

      try {
        const zplCode = generateZPLForRealPrinter(lastQRCode);
        await sendToPrinter(zplCode);
        
        showPrintingStatus('‚úÖ ƒê√£ g·ª≠i l·ªánh in t·ªõi m√°y in ZT610!', 'success');
        updatePrinterStatus('‚úÖ M√°y in ZT610 s·∫µn s√†ng', 'connected');
        
      } catch (error) {
        console.error('L·ªói in:', error);
        showPrintingStatus('‚ùå L·ªói in: ' + error.message, 'error');
        updatePrinterStatus('‚ùå L·ªói k·∫øt n·ªëi m√°y in', 'disconnected');
        showZPLFallback(generateZPLForRealPrinter(lastQRCode));
      }
      
      closeQRPrint();
    }

    // Hi·ªÉn th·ªã tr·∫°ng th√°i in
    function showPrintingStatus(message, type = 'info') {
      const statusDiv = document.createElement('div');
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      statusDiv.textContent = message;
      
      document.body.appendChild(statusDiv);
      
      setTimeout(() => {
        document.body.removeChild(statusDiv);
      }, 3000);
    }

    // Hi·ªÉn th·ªã ZPL fallback
    function showZPLFallback(zplCode) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;

      const fallbackWindow = document.createElement('div');
      fallbackWindow.style.cssText = `
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 500px;
        max-width: 90%;
        max-height: 80%;
        overflow: auto;
      `;

      fallbackWindow.innerHTML = `
        <h3 style="color: #e74c3c; margin-top: 0;">‚ö†Ô∏è KH√îNG TH·ªÇ K·∫æT N·ªêI M√ÅY IN ZT610</h3>
        <p>Copy ZPL code b√™n d∆∞·ªõi v√† g·ª≠i th·ªß c√¥ng t·ªõi m√°y in:</p>
        
        <textarea 
          id="zplCodeTextarea" 
          style="width: 100%; height: 200px; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;"
          readonly>${zplCode}</textarea>
        
        <div style="display: flex; gap: 10px;">
          <button onclick="copyZPLCode()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; flex: 1;">
            üìã Copy ZPL Code
          </button>
          <button onclick="closeFallback()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; flex: 1;">
            ƒê√≥ng
          </button>
        </div>
        
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
          <strong>H∆∞·ªõng d·∫´n:</strong> D√°n ZPL code v√†o ph·∫ßn m·ªÅm qu·∫£n l√Ω m√°y in Zebra ho·∫∑c g·ª≠i tr·ª±c ti·∫øp t·ªõi c·ªïng m√°y in.
        </div>
      `;

      overlay.appendChild(fallbackWindow);
      document.body.appendChild(overlay);

      window.copyZPLCode = function() {
        const textarea = document.getElementById('zplCodeTextarea');
        textarea.select();
        document.execCommand('copy');
        showPrintingStatus('‚úÖ ƒê√£ copy ZPL code!', 'success');
      };

      window.closeFallback = function() {
        document.body.removeChild(overlay);
      };
    }

    // ===== PH·∫¶N PH√ÅN ƒê·ªäNH S·∫¢N PH·∫®M (GI·ªÆ NGUY√äN) =====
    const users = {
      "5035": "123456",
      "5624": "562411",
      "5814": "241012",
      "4549": "130417",
      "5372": "537211",
      "5171": "517111",
      "5651": "565111",
      "5531": "553111",
      "5019": "501911",
    };

    const maxLengthByProduct = {
      "ECM-2583-236": 20,
      "ECM-2583-164": 20,
      "ECM-2300": 15,
      "ECM-2310": 15,
      "IZ-1-R3": 48,
      "RM-4K-R3": 48,
      "AM-4-R3": 48,
      "P-7937": 15,
      "P-8105": 15,
      "P-8149": 15,
      "BMS 85AH": 22,
      "BMS 57AH": 22,
      "CONTROLLER": 22,
      "CAS NEMO": 12,
      "CAS MINI-DI": 15,
      "CAS MINI-485": 15,
      "BN 2573A": 12,
      "OEM": 20
    };

    let records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫","Synced"]];
    let qrCounter = {};
    let currentUser = "";
    let currentShift = "";
    let currentWO = "";
    let okCount = 0, ngCount = 0;
    let chart;

    let deliveryTarget = 0;
    let deliveryCounter = 0;
    let lastQRCode = null;

    // Load t·ª´ localStorage
    if (localStorage.getItem("records")) {
      try { 
        const savedRecords = JSON.parse(localStorage.getItem("records"));
        if (Array.isArray(savedRecords) && savedRecords.length > 0) {
          records = savedRecords;
        }
      } catch(e) { 
        console.error("L·ªói khi load records t·ª´ localStorage:", e);
      }
    }
    
    if (localStorage.getItem("qrCounter")) {
      try { 
        qrCounter = JSON.parse(localStorage.getItem("qrCounter")); 
      } catch(e) { 
        console.error("L·ªói khi load qrCounter t·ª´ localStorage:", e);
      }
    }

    function updateQRCodeMaxLength() {
      const mahang = document.getElementById("mahang").value;
      const infoElement = document.getElementById("qrcodeLengthInfo");
      
      if (mahang && maxLengthByProduct[mahang]) {
        const maxLength = maxLengthByProduct[mahang];
        infoElement.textContent = `QR Code t·ªëi ƒëa ${maxLength} k√Ω t·ª±`;
        infoElement.style.color = "#27ae60";
      } else {
        infoElement.textContent = "";
      }
    }

    function recomputeCountsForShift(shift) {
      let ok = 0, ng = 0;
      const latestResults = {};
      
      for (let i = 1; i < records.length; i++) {
        const row = records[i];
        if (row[8] === shift) {
          const qrcode = row[1];
          if (!latestResults[qrcode] || i > latestResults[qrcode].index) {
            latestResults[qrcode] = {
              result: row[2],
              index: i
            };
          }
        }
      }
      
      for (const qrcode in latestResults) {
        if (latestResults[qrcode].result === "OK") ok++;
        else if (latestResults[qrcode].result === "NG") ng++;
      }
      
      okCount = ok; 
      ngCount = ng;
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();
    }

    function login() {
      const uRaw = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      const s = document.getElementById("shift").value;
      const wo = document.getElementById("wo").value.trim();
      
      if (!uRaw || !wo) { 
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!"; 
        return; 
      }
      
      const u = uRaw.toUpperCase();
      if (users[u] && users[u] === p) {
        currentUser = u;
        currentShift = s;
        currentWO = wo;
        document.getElementById("currentUser").textContent = currentUser;
        document.getElementById("currentShift").textContent = currentShift;
        document.getElementById("currentWO").textContent = currentWO;
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainApp").style.display = "flex";
        recomputeCountsForShift(currentShift);
        renderTable();
      } else {
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!";
      }
    }

    function saveData(result) {
      if (deliveryTarget === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p S·ªê L∆Ø·ª¢NG GIAO tr∆∞·ªõc khi qu√©t!");
        return;
      }
      if (deliveryCounter >= deliveryTarget) {
        alert("‚ö†Ô∏è ƒê√£ ƒë·ªß s·ªë l∆∞·ª£ng giao, kh√¥ng th·ªÉ qu√©t th√™m!");
        return;
      }

      const mahang = document.getElementById("mahang").value.trim().toUpperCase();
      const qrcode = document.getElementById("qrcode").value.trim().toUpperCase();
      const loi = document.getElementById("loi").value.trim();
      const ghichu = document.getElementById("ghichu").value.trim();

      if (!mahang || !qrcode) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ h√†ng v√† QR Code!";
        return;
      }

      const maxLength = maxLengthByProduct[mahang];
      if (maxLength && qrcode.length > maxLength) {
        alert(`‚ö†Ô∏è QR Code cho m√£ h√†ng ${mahang} v∆∞·ª£t qu√° ${maxLength} k√Ω t·ª±!`);
        document.getElementById("qrcode").value = "";
        document.getElementById("qrcode").focus();
        return;
      }

      document.getElementById("error").textContent = "";
      qrCounter[qrcode] = (qrCounter[qrcode] || 0) + 1;

      const now = new Date();
      const gio = now.toLocaleTimeString("vi-VN");
      const ngay = now.toLocaleDateString("vi-VN");

      if (qrcode) {
        lastQRCode = { code: qrcode, mahang: mahang, wo: currentWO };
      }

      let oldOkCount = 0, oldNgCount = 0;
      for (let i = 1; i < records.length; i++) {
        if (records[i][1] === qrcode) {
          if (records[i][2] === "OK") oldOkCount++;
          else if (records[i][2] === "NG") oldNgCount++;
        }
      }

      okCount = okCount - oldOkCount;
      ngCount = ngCount - oldNgCount;
      if (result === "OK") okCount++; else ngCount++;

      records.push([
        mahang, qrcode, result, loi, gio, ngay,
        qrCounter[qrcode], currentUser, currentShift,
        currentWO, ghichu, false
      ]);

      saveLocal();
      renderTable();
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();

      document.getElementById("qrcode").value = "";
      document.getElementById("loi").value = "";
      document.getElementById("ghichu").value = "";

      deliveryCounter++;
      document.getElementById("deliveryStatus").textContent = `ƒê√£ qu√©t ${deliveryCounter}/${deliveryTarget}`;

      if (deliveryCounter >= deliveryTarget) {
        alert(`‚úÖ ƒê√£ ƒë·ªß ${deliveryTarget} s·∫£n ph·∫©m!`);
        document.getElementById("deliveryQty").value = 0;
        deliveryTarget = 0;
        deliveryCounter = 0;
        document.getElementById("deliveryStatus").textContent = "";
      }

      const qEl = document.getElementById("qrcode");
      if (qEl) { qEl.focus(); qEl.select(); }

      if (result === "OK" && lastQRCode) {
        setTimeout(() => printQRNow(), 500);
      }

      syncToSheet();
    }

    function printQRCode() {
      if (!lastQRCode) {
        alert("Ch∆∞a c√≥ QR code ƒë·ªÉ in! H√£y qu√©t QR code tr∆∞·ªõc.");
        return;
      }
      
      document.getElementById('qrCodeDisplay').textContent = lastQRCode.code;
      
      // T·∫°o QR code h√¨nh ·∫£nh trong popup
      const qrCodeElement = document.getElementById('qrCodeDisplay');
      qrCodeElement.innerHTML = '';
      
      QRCode.toCanvas(qrCodeElement, lastQRCode.code, {
        width: 150,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      }, function (error) {
        if (error) {
          console.error(error);
          qrCodeElement.textContent = lastQRCode.code;
        }
      });
      
      document.getElementById('printOverlay').style.display = 'block';
      document.getElementById('qrPrintContainer').style.display = 'block';
    }

    function printQRNow() {
      if (!lastQRCode) {
        alert("Kh√¥ng c√≥ QR code ƒë·ªÉ in!");
        return;
      }

      // ZPL code CH·ªà in QR code (kh√¥ng c√≥ text kh√°c)
      const zplCode = `^XA^FO20,20^BQN,2,6^FDQA,${lastQRCode.code}^FS^XZ`;

      // Hi·ªÉn th·ªã c·ª≠a s·ªï gi·∫£ l·∫≠p m√°y in
      showVirtualPrinter(zplCode, lastQRCode);
      closeQRPrint();
    }

    // H√†m hi·ªÉn th·ªã m√°y in ·∫£o (ch·ªâ QR code)
    function showVirtualPrinter(zplCode, qrData) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;

      const printerWindow = document.createElement('div');
      printerWindow.style.cssText = `
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 350px;
        text-align: center;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
      `;

      // S·ª≠ d·ª•ng API t·∫°o QR code ƒë∆°n gi·∫£n
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData.code)}`;

      printerWindow.innerHTML = `
        <h2 style="color: #2c3e50; margin: 0 0 15px 0;">üñ®Ô∏è IN QR CODE</h2>
        
        <div style="background: #d4edda; padding: 8px; border-radius: 5px; margin: 10px 0;">
          <strong style="color: #155724;">‚úì M√ÅY IN S·∫¥N S√ÄNG</strong>
        </div>

        <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; margin: 15px 0;">
          <div style="font-size: 14px; color: #666; margin-bottom: 5px;">M√É S·∫º IN:</div>
          <div style="font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; color: #2c3e50; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd; word-break: break-all;">
            ${qrData.code}
          </div>
        </div>

        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0; border: 2px solid #27ae60;">
          <div style="font-size: 14px; color: #155724; margin-bottom: 10px; font-weight: bold;">üéØ QR CODE:</div>
          <img src="${qrCodeUrl}" 
               alt="QR Code" 
               style="border: 3px solid #2c3e50; border-radius: 8px; background: white; width: 150px; height: 150px;"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+UVLigIJDb2RlPC90ZXh0Pjx0ZXh0IHg9IjUwJSIgeT0iNjAlIiBmb250LXNpemU9IjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+JHtxckRhdGEuY29kZX08L3RleHQ+PC9zdmc+'.replace('${qrData.code}', qrData.code);">
          <div style="margin-top: 8px; font-size: 11px; color: #666;">
            Qu√©t th·ª≠ QR code n√†y
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button onclick="simulatePrintSuccess(this)" style="
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            flex: 1;
          ">‚úÖ IN NGAY</button>
          
          <button onclick="closeVirtualPrinter(this)" style="
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
          ">‚ùå H·ª¶Y</button>
        </div>

        <div style="margin-top: 15px; font-size: 10px; color: #7f8c8d; background: #f8f9fa; padding: 8px; border-radius: 3px;">
          <strong>ZPL:</strong> ${zplCode}
        </div>
      `;

      overlay.appendChild(printerWindow);
      document.body.appendChild(overlay);

      overlay.closePrinter = () => document.body.removeChild(overlay);
    }

    function simulatePrintSuccess(button) {
      const overlay = button.closest('div[style*="position: fixed"]');
      
      button.innerHTML = 'üñ®Ô∏è ƒêang in...';
      button.style.background = '#f39c12';
      button.disabled = true;
      
      setTimeout(() => {
        button.innerHTML = '‚úÖ In th√†nh c√¥ng!';
        button.style.background = '#27ae60';
        
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
          background: #d4edda;
          color: #155724;
          padding: 10px;
          border-radius: 5px;
          margin: 10px 0;
          text-align: center;
          border: 1px solid #c3e6cb;
        `;
        successMsg.innerHTML = 'üéâ QR code ƒë√£ ƒë∆∞·ª£c in th√†nh c√¥ng!';
        
        button.parentNode.insertBefore(successMsg, button);
        
        setTimeout(() => {
          if (overlay.closePrinter) overlay.closePrinter();
        }, 2000);
      }, 1500);
    }

    function closeVirtualPrinter(button) {
      const overlay = button.closest('div[style*="position: fixed"]');
      if (overlay.closePrinter) overlay.closePrinter();
    }

    function closeQRPrint() {
      document.getElementById('printOverlay').style.display = 'none';
      document.getElementById('qrPrintContainer').style.display = 'none';
    }

    function renderTable() {
      const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";

      const search = document.getElementById("searchBox").value.toLowerCase();
      const filterRes = document.getElementById("filterResult").value;

      for (let i = records.length - 1; i >= 1; i--) {
        const rowData = records[i];
        
        if (search && !rowData[0].toLowerCase().includes(search) && !rowData[1].toLowerCase().includes(search)) continue;
        if (filterRes && rowData[2] !== filterRes) continue;

        const tr = tbody.insertRow();
        
        let bgColor = "white";
        if (rowData[2] === "NG") {
          bgColor = "#ffcccc";
        } else if (rowData[2] === "OK") {
          const hasPreviousNG = checkIfHasPreviousNG(rowData[1], i);
          if (hasPreviousNG) {
            bgColor = "#ccffcc";
          } else {
            bgColor = "white";
          }
        }
        tr.style.backgroundColor = bgColor;

        for (let j = 0; j < 11; j++) {
          const td = tr.insertCell();
          td.textContent = rowData[j] || "";
        }

        const tdDel = tr.insertCell();
        const btn = document.createElement("button");
        btn.textContent = "X√≥a";
        btn.style.background = "#e74c3c";
        btn.style.color = "white";
        btn.style.border = "none";
        btn.style.padding = "4px 8px";
        btn.style.borderRadius = "4px";
        btn.onclick = () => deleteRecord(i);
        tdDel.appendChild(btn);

        if ((rowData[6] || 0) > 1) tr.classList.add("duplicate");
      }
    }

    function checkIfHasPreviousNG(qrcode, currentIndex) {
      for (let i = currentIndex - 1; i >= 1; i--) {
        if (records[i][1] === qrcode && records[i][2] === "NG") {
          return true;
        }
      }
      return false;
    }

    function saveLocal() {
      try {
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("qrCounter", JSON.stringify(qrCounter));
      } catch(e) { 
        console.warn("L∆∞u localStorage th·∫•t b·∫°i:", e); 
      }
    }

    function exportCSV() {
      if (!currentShift || !currentWO) {
        alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ca + WO tr∆∞·ªõc khi xu·∫•t file!");
        return;
      }

      let mahang = document.getElementById("mahang").value.trim();
      if (!mahang) { 
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ h√†ng tr∆∞·ªõc khi xu·∫•t file!"); 
        return; 
      }

      let filteredRecords = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫"]];
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          filteredRecords.push(records[i]);
        }
      }

      if (filteredRecords.length <= 1) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu n√†o cho ca n√†y!");
        return;
      }

      let now = new Date();
      let filename = `${mahang}_${currentShift.replace(/\s+/g, "_")}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.csv`;

      let csvContent = "\uFEFF" + filteredRecords.map(e => e.join(",")).join("\n");
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let link = document.createElement("a");
      if (link.download !== undefined) {
        let url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function syncToSheet() {
      const sheetUrl = "https://script.google.com/macros/s/AKfycbwGCEDo7faBhEh9FCv1ZlrfINyAvfwIg9EbXk-CqwZRYBKVOQJP2hIGjI02JbeWIYJC5A/exec"; 
      
      const dataToSend = records
      .slice(1)
      .filter(r => !r[11]);

      if (dataToSend.length === 0) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô!");
        return;
      }

      console.log("D·ªØ li·ªáu g·ª≠i l√™n Google Sheets:", dataToSend);

      fetch(sheetUrl, {
        method: "POST",
        body: JSON.stringify(dataToSend),
        headers: { "Content-Type": "application/json" },
        mode: "no-cors"
      })
      .then(() => {
        alert("‚úÖ ƒê√£ g·ª≠i d·ªØ li·ªáu l√™n Google Sheets");
        records = records.map(r => {
          if (r[11] === false) r[11] = true;
          return r;
        });
        saveLocal();
        console.log("ƒê√£ ƒë√°nh d·∫•u synced:", records);
      })
      .catch(err => {
        alert("‚ùå L·ªói ƒë·ªìng b·ªô: " + err);
        console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      });
    }

    function endShiftReport() {
      let summary = {};
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          let mahang = records[i][0];
          let result = records[i][2];
          let loi = records[i][3];

          if (!summary[mahang]) {
            summary[mahang] = { ok: 0, ng: 0, loiCount: {} };
          }

          if (result === "OK") {
            summary[mahang].ok++;
          } else if (result === "NG") {
            summary[mahang].ng++;
            summary[mahang].loiCount[loi] = (summary[mahang].loiCount[loi] || 0) + 1;
          }
        }
      }

      let report = `üìä B√°o c√°o ca ${currentShift} (WO: ${currentWO}):\n`;
      for (let mahang in summary) {
        let ok = summary[mahang].ok;
        let ng = summary[mahang].ng;
        let total = ok + ng;
        let tyLeNG = total ? ((ng / total) * 100).toFixed(2) : 0;
        let top3 = Object.entries(summary[mahang].loiCount)
                         .sort((a,b)=>b[1]-a[1])
                         .slice(0,3)
                         .map(x => `${x[0]}(${x[1]})`)
                         .join(", ") || "Kh√¥ng c√≥";

        report += `\nüì¶ M√£ h√†ng: ${mahang}\n‚úÖ OK: ${ok} | ‚ùå NG: ${ng} | üìâ T·ª∑ l·ªá NG: ${tyLeNG}%\nüî• Top l·ªói: ${top3}\n`;
      }

      alert(report);
    }

    function updateChart() {
      const canvas = document.getElementById("chartOKNG");
      if (!canvas) return;
      
      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();
      
      try {
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["OK", "NG"],
            datasets: [{
              data: [okCount, ngCount],
              backgroundColor: ["#2ecc71", "#e74c3c"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "50%",
            radius: "90%",
            plugins: { 
              legend: { 
                position: "right",
                labels: {
                  usePointStyle: true,
                  padding: 20
                }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o bi·ªÉu ƒë·ªì:", e);
      }
    }

    function clearLogDisplay() {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng hi·ªÉn th·ªã? (D·ªØ li·ªáu v·∫´n c√≤n l∆∞u trong b·ªô nh·ªõ)")) return;
      document.querySelector("#logTable tbody").innerHTML = "";
      alert("‚úÖ ƒê√£ x√≥a hi·ªÉn th·ªã log. D·ªØ li·ªáu g·ªëc v·∫´n c√≤n!");
    }

    function resetAllData() {
      if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu (records + b·ªô ƒë·∫øm)?")) return;

      const backupKey = "backup_records_" + (new Date()).toISOString();
      try {
        localStorage.setItem(backupKey, JSON.stringify(records));
        localStorage.setItem(backupKey + "_qr", JSON.stringify(qrCounter));
      } catch(e) { console.warn("Backup th·∫•t b·∫°i:", e); }

      records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫"]];
      qrCounter = {};
      okCount = 0; ngCount = 0;
      lastQRCode = null;
      saveLocal();

      renderTable();
      recomputeCountsForShift(currentShift || "");
      alert("‚úÖ ƒê√£ reset d·ªØ li·ªáu. B·∫£n backup ƒë√£ l∆∞u v√†o localStorage v·ªõi key: " + backupKey);
    }

    function deleteRecord(index) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?")) return;

      index = Number(index);
      if (isNaN(index) || index < 1 || index >= records.length) {
        alert("Kh√¥ng t√¨m th·∫•y b·∫£n ghi ƒë·ªÉ x√≥a.");
        return;
      }

      const removed = records.splice(index, 1)[0];
      const removedQr = removed[1];
      
      recomputeCountsForShift(currentShift);
      
      saveLocal();
      renderTable();
    }

    // ===== PH·∫¶N B√ÅO C√ÅO & TH·ªêNG K√ä =====
    const API_URL = "https://script.google.com/macros/s/AKfycbwGCEDo7faBhEh9FCv1ZlrfINyAvfwIg9EbXk-CqwZRYBKVOQJP2hIGjI02JbeWIYJC5A/exec";
    let allData = [];
    let filteredDataGlobal = [];
    let paretoChart, dailyChart;
    let clusterize = null;

    function parseDateString(str){
      if(!str) return null;
      str = str.toString().trim();

      const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m1){
        const d = parseInt(m1[1],10);
        const m = parseInt(m1[2],10) - 1;
        const y = parseInt(m1[3],10);
        const date = new Date(y, m, d, 12, 0, 0);
        return date;
      }

      const m2 = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if(m2){
        const y = parseInt(m2[1],10);
        const m = parseInt(m2[2],10)-1;
        const d = parseInt(m2[3],10);
        return new Date(y,m,d,12,0,0);
      }

      const d2 = new Date(str);
      if(!isNaN(d2)) return new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(), 12, 0, 0);

      return null;
    }

    function isoDate(d){
      if (!(d instanceof Date) || isNaN(d)) return null;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }

    function populateFilters(data){
      const maSPs = new Set();
      const pos = new Set();
      data.forEach(r=>{
        if (r.maHang) maSPs.add(r.maHang);
        if (r.po) pos.add(r.po);
      });
      fillSelect("maSP",maSPs);
      fillSelect("po",pos);
    }

    function fillSelect(id, values){
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">T·∫•t c·∫£</option>`;
      values.forEach(v=>select.innerHTML+=`<option value="${v}">${v}</option>`);
    }

    function reloadFromGoogle(){
      fetch(API_URL)
        .then(res=>{
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data=>{
          allData = data || [];
          populateFilters(allData);
          renderReportTable(allData);
          
          if (allData.length > 0) {
            setTimeout(() => {
              drawPareto(allData);
              drawDailyChart(allData);
            }, 100);
          }
        })
        .catch(err=>{
          console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu:", err);
          alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu: " + err.message);
        });
    }

    function applyFilters() {
      window.preventAutoReload = true;
      const searchQR = document.getElementById("searchQR").value.trim().toUpperCase();
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const maSP = document.getElementById("maSP").value;
      const po = document.getElementById("po").value;

      filteredDataGlobal = allData.filter(r => {
        let match = true;

        const qrValue = r["QR Code"] || r["Qr code"] || r["QR code"] || r.qrCode || r.qr || "";
        const maHangValue = r["M√£ h√†ng"] || r.maHang || "";
        const poValue = r["PO"] || r.po || "";
        const ngayStr = r["Ng√†y"] || r.ngay;
        const ngay = parseDateString(ngayStr);

        if (searchQR && !qrValue.toString().toUpperCase().includes(searchQR)) match = false;
        if (maSP && maHangValue !== maSP) match = false;
        if (po && poValue !== po) match = false;

        if (fromDate && ngay < new Date(fromDate)) match = false;
        if (toDate) {
          const to = new Date(toDate);
          to.setHours(23, 59, 59, 999);
          if (ngay > to) match = false;
        }

        return match;
      });

      renderReportTable(filteredDataGlobal);
      drawPareto(filteredDataGlobal);
      drawDailyChart(filteredDataGlobal);
      
      alert(`‚úÖ ƒê√£ l·ªçc ƒë∆∞·ª£c ${filteredDataGlobal.length} d√≤ng. Bi·ªÉu ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!`);
    }

    function renderReportTable(data) {
      const rows = data.map(r => {
        let gioRaw = r["Gi·ªù"] || r.gio || "";
        let ngayRaw = r["Ng√†y"] || r.ngay || "";

        function formatDateTime(value, type="date") {
          if (!value) return "";
          try {
            const d = new Date(value);
            if (isNaN(d)) return value;
            if (type === "time") return d.toLocaleTimeString("vi-VN", { hour12: false });
            return d.toLocaleDateString("vi-VN");
          } catch {
            return value;
          }
        }

        const gio = formatDateTime(gioRaw, "time");
        const ngay = formatDateTime(ngayRaw, "date");

        return `
          <tr>
            <td>${r["M√£ h√†ng"] || r.maHang || ""}</td>
            <td>${r["QR code"] || r.qrCode || ""}</td>
            <td>${r["Ph√°n ƒë·ªãnh"] || r.phanDinh || ""}</td>
            <td>${r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || ""}</td>
            <td>${gio}</td>
            <td>${ngay}</td>
            <td>${r["S·ªë l·∫ßn xu·∫•t hi·ªán"] || r.soLan || ""}</td>
            <td>${r["M√£ Nh√¢n Vi√™n"] || r.maNV || r.User || ""}</td>
            <td>${r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || ""}</td>
            <td>${r["PO"] || r.po || ""}</td>
            <td>${r["Ghi ch√∫"] || r.ghichu || ""}</td>
          </tr>
        `;
      });

      if (!clusterize) {
        clusterize = new Clusterize({
          rows: rows,
          scrollId: 'scrollArea',
          contentId: 'clusterize-content'
        });
      } else {
        clusterize.update(rows);
      }

      const info = document.getElementById("recordCount");
      if (info) info.textContent = `T·ªïng: ${data.length} d√≤ng`;
    }
    
    function drawPareto(data){
      const canvas = document.getElementById("paretoChart");
      if (!canvas) {
        console.error("Kh√¥ng t√¨m th·∫•y canvas paretoChart");
        return;
      }

      const ctx = canvas.getContext("2d");
      if (!ctx) {
        console.error("Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas");
        return;
      }

      const loiCount = {};
      data.forEach(r=>{
        const moTaLoi = r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || "";
        const phanDinh = r["Ph√°n ƒë·ªãnh"] || r.phanDinh || "";
        
        if (moTaLoi && phanDinh === "NG") {
          loiCount[moTaLoi] = (loiCount[moTaLoi] || 0) + 1;
        }
      });
      
      const loiSorted = Object.entries(loiCount).sort((a,b)=>b[1]-a[1]);
      const labels = loiSorted.map(x=>x[0]);
      const values = loiSorted.map(x=>x[1]);
      const total = values.reduce((a,b)=>a+b,0);
      const cumsum = values.map((sum=>v=>sum+=v)(0));
      const cumPerc = cumsum.map(s=>(s/total*100).toFixed(1));

      if (paretoChart) {
        try {
          paretoChart.destroy();
        } catch(e) {
          console.warn("L·ªói khi destroy paretoChart c≈©:", e);
        }
      }

      try {
        paretoChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "S·ªë l·ªói",
              data: values,
              backgroundColor: "#3498db",
              order: 2
            },{
              label: "T·ª∑ l·ªá t√≠ch l≈©y (%)",
              data: cumPerc,
              type: "line",
              borderColor: "#e74c3c",
              backgroundColor: "rgba(231,76,60,0.1)",
              fill: true,
              yAxisID: "y1",
              order: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "S·ªë l·ªói" }
              },
              y1: {
                position: "right",
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "T·ª∑ l·ªá %" },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o paretoChart:", e);
      }
    }

    function drawDailyChart(data) {
  const canvas = document.getElementById("dailyChart");
  if (!canvas) {
    console.error("Kh√¥ng t√¨m th·∫•y canvas dailyChart");
    return;
  }

  const ctx = canvas.getContext("2d");
  if (!ctx) {
    console.error("Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas");
    return;
  }

  const dailyCount = {};
  let minDate = null, maxDate = null;

  data.forEach(r => {
    const ngayStr = r["Ng√†y"] || r.ngay;
    const phanDinh = r["Ph√°n ƒë·ªãnh"] || r.phanDinh || "";
    
    if (ngayStr) {
      const d = parseDateString(ngayStr);
      if (d) {
        if (!minDate || d < minDate) minDate = d;
        if (!maxDate || d > maxDate) maxDate = d;

        const iso = isoDate(d);
        if (!dailyCount[iso]) dailyCount[iso] = { ok: 0, ng: 0 };
        if (phanDinh === "OK") dailyCount[iso].ok++;
        else if (phanDinh === "NG") dailyCount[iso].ng++;
      }
    }
  });

  const dates = [];
  if (minDate && maxDate) {
    let cur = new Date(minDate);
    while (cur <= maxDate) {
      dates.push(isoDate(cur));
      cur.setDate(cur.getDate() + 1);
    }
  }

  const okData = dates.map(d => dailyCount[d]?.ok || 0);
  const ngData = dates.map(d => dailyCount[d]?.ng || 0);
  const totalData = dates.map(d => (dailyCount[d]?.ok || 0) + (dailyCount[d]?.ng || 0));
  const percNG = dates.map(d => {
    const total = (dailyCount[d]?.ok || 0) + (dailyCount[d]?.ng || 0);
    return total > 0 ? ((dailyCount[d].ng / total) * 100).toFixed(2) : 0;
  });

  if (dailyChart) {
    try {
      dailyChart.destroy();
    } catch(e) {
      console.warn("L·ªói khi destroy dailyChart c≈©:", e);
    }
  }

  try {
    dailyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: dates,
        datasets: [
          {
            label: "T·ªïng s·ªë l∆∞·ª£ng",
            data: totalData,
            backgroundColor: "#2ecc71",
            yAxisID: "y",
          },
          {
            label: "NG",
            data: ngData,
            backgroundColor: "#e74c3c",
            yAxisID: "y",
          },
          {
            label: "% NG/T·ªïng",
            data: percNG,
            type: "line",
            borderColor: "#2980b9",
            backgroundColor: "rgba(52,152,219,0.1)",
            yAxisID: "y1",
            tension: 0.3,
            fill: false,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "S·ªë l∆∞·ª£ng" }
          },
          y1: {
            position: "right",
            beginAtZero: true,
            max: 100,
            title: { display: true, text: "% NG" },
            grid: { drawOnChartArea: false }
          },
          x: {
            title: { display: true, text: "Ng√†y" }
          }
        }
      }
    });
  } catch(e) {
    console.error("L·ªói khi t·∫°o dailyChart:", e);
  }
}

// Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
window.onload = function() {
  recomputeCountsForShift(currentShift || "");
  renderTable();
  updateChart();
  loadPrinterConfig();

  // Th√™m event listeners cho lo·∫°i m√°y in
  document.querySelectorAll('input[name="printerType"]').forEach(radio => {
    radio.addEventListener('change', updatePrinterTypeUI);
  });

  document.getElementById("deliveryQty").addEventListener("input", ()=>{
    deliveryTarget = parseInt(document.getElementById("deliveryQty").value) || 0;
    deliveryCounter = 0;
    if (deliveryTarget > 0) {
      document.getElementById("deliveryStatus").textContent = `üîÑ ƒê√£ ƒë·∫∑t m·ª•c ti√™u: ${deliveryTarget}`;
    } else {
      document.getElementById("deliveryStatus").textContent = "";
    }
  });

  window.addEventListener("storage", (event) => {
    if (event.key === "records") {
      records = JSON.parse(event.newValue || "[]");
      renderTable();
      recomputeCountsForShift(currentShift || "");
    }
  });
}

// Th√™m c√°c h√†m c√≤n thi·∫øu
function simulatePrintSuccess(button) {
  const overlay = button.closest('div[style*="position: fixed"]');
  
  button.innerHTML = 'üñ®Ô∏è ƒêang in...';
  button.style.background = '#f39c12';
  button.disabled = true;
  
  setTimeout(() => {
    button.innerHTML = '‚úÖ In th√†nh c√¥ng!';
    button.style.background = '#27ae60';
    
    const successMsg = document.createElement('div');
    successMsg.style.cssText = `
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      border: 1px solid #c3e6cb;
    `;
    successMsg.innerHTML = 'üéâ QR code ƒë√£ ƒë∆∞·ª£c in th√†nh c√¥ng!';
    
    button.parentNode.insertBefore(successMsg, button);
    
    setTimeout(() => {
      if (overlay.closePrinter) overlay.closePrinter();
    }, 2000);
  }, 1500);
}

function closeVirtualPrinter(button) {
  const overlay = button.closest('div[style*="position: fixed"]');
  if (overlay && overlay.closePrinter) overlay.closePrinter();
}

function copyZPLCode() {
  const textarea = document.getElementById('zplCodeTextarea');
  if (textarea) {
    textarea.select();
    document.execCommand('copy');
    showPrintingStatus('‚úÖ ƒê√£ copy ZPL code!', 'success');
  }
}

function closeFallback() {
  const overlay = document.querySelector('div[style*="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8)"]');
  if (overlay) {
    document.body.removeChild(overlay);
  }
}
</script>
</body>
</html>